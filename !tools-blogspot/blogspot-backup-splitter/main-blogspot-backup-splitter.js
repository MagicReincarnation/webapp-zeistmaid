let selectedFile=null,processedFiles=[],seriesData={},labels_series=null,labels_chapter=null;const uploadArea=document.getElementById("uploadArea"),fileInput=document.getElementById("fileInput"),processBtn=document.getElementById("processBtn"),progress=document.getElementById("progress"),progressBar=document.getElementById("progressBar"),status=document.getElementById("status"),downloadArea=document.getElementById("downloadArea"),fileInfo=document.getElementById("fileInfo"),errorMsg=document.getElementById("errorMsg"),postsPerFileInput=document.getElementById("postsPerFile"),groupBySeriesSelect=document.getElementById("groupBySeries"),seriesAnalysis=document.getElementById("seriesAnalysis"),seriesStats=document.getElementById("seriesStats"),seriesTableBody=document.getElementById("seriesTableBody");function handleDragOver(e){e.preventDefault(),uploadArea.classList.add("dragover")}function handleDragLeave(){uploadArea.classList.remove("dragover")}function handleDrop(e){e.preventDefault(),uploadArea.classList.remove("dragover");let t=e.dataTransfer.files;t.length>0&&handleFile(t[0])}function handleFileSelect(e){let t=e.target.files[0];t&&handleFile(t)}async function handleFile(e){if(!e.name.toLowerCase().endsWith(".xml")){showError("File harus berformat .xml (backup Blogspot)");return}selectedFile=e,fileInfo.style.display="block",fileInfo.innerHTML=`
    <h4><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20"><g fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"><path d="M5.5 4a2 2 0 0 1 2-2h5.1a.5.5 0 0 1 .35.144l4.4 4.333a.5.5 0 0 1 .15.356V14a2 2 0 0 1-2 2h-9a.5.5 0 0 1 0-1h9a1 1 0 0 0 1-1V7.333h-2.9a1.5 1.5 0 0 1-1.5-1.5V3H7.5a1 1 0 0 0-1 1v2.5a.5.5 0 0 1-1 0zm7.6-.306l2.68 2.64H13.6a.5.5 0 0 1-.5-.5z"/><path d="M7.998 8.628a2.291 2.291 0 1 0-2.15 4.047a2.291 2.291 0 0 0 2.15-4.047m-3.981.48a3.291 3.291 0 1 1 1.82 4.652l-1.61 3.03a.5.5 0 1 1-.883-.47l1.61-3.03a3.29 3.29 0 0 1-.937-4.183"/></g></svg> File Info:</h4>
    <p><strong>Nama:</strong> ${e.name}</p>
    <p><strong>Ukuran:</strong> ${formatFileSize(e.size)}</p>
    <p><strong>Tanggal:</strong> ${new Date(e.lastModified).toLocaleString("id-ID")}</p>
    <p><strong>Status:</strong> <span style="color: var(--warning-color);">Siap untuk dianalisis</span></p>
  `,processBtn.disabled=!1,hideError()}async function processFile(){if(!selectedFile)return;let e=parseInt(postsPerFileInput.value);if(e<1||e>5e3){showError("Jumlah post per file harus antara 1-5000");return}processBtn.disabled=!0,progress.style.display="block",status.style.display="block",downloadArea.style.display="none",document.getElementById("downloadAllBtn").style.display="none",processedFiles=[];try{updateStatus('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 1024 1024"><path fill="currentColor" d="m512 863.36l384-54.848v-638.72L525.568 222.72a96 96 0 0 1-27.136 0L128 169.792v638.72zM137.024 106.432l370.432 52.928a32 32 0 0 0 9.088 0l370.432-52.928A64 64 0 0 1 960 169.792v638.72a64 64 0 0 1-54.976 63.36l-388.48 55.488a32 32 0 0 1-9.088 0l-388.48-55.488A64 64 0 0 1 64 808.512v-638.72a64 64 0 0 1 73.024-63.36"/><path fill="currentColor" d="M480 192h64v704h-64z"/></svg> Membaca file XML...'),updateProgress(10);let t=await readFileAsText(selectedFile),l=new DOMParser,s=l.parseFromString(t,"text/xml"),a=s.querySelector("parsererror");if(a)throw Error("File XML tidak valid atau rusak");updateStatus("Menganalisis posts dan series..."),updateProgress(30);let r=s.querySelectorAll("entry"),n=r.length;if(0===n)throw Error("Tidak ditemukan post dalam file backup");seriesData=analyzeSeriesAndChapters(r),displaySeriesAnalysis(),updateStatus('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M5 7a2 2 0 1 0 0-4a2 2 0 0 0 0 4m14 0a2 2 0 1 0 0-4a2 2 0 0 0 0 4m2 12a2 2 0 1 1-4 0a2 2 0 0 1 4 0M5 21a2 2 0 1 0 0-4a2 2 0 0 0 0 4M7.959 5.5a3 3 0 0 0-.13-1.5H12.5A2.5 2.5 0 0 1 15 6.5V9h2.5a2.5 2.5 0 0 1 2.5 2.5v4.67a3 3 0 0 0-1.5-.129V11.5a1 1 0 0 0-1-1H15v2a2.5 2.5 0 0 1-2.5 2.5h-2v2.5a1 1 0 0 0 1 1h4.541a3 3 0 0 0 .13 1.5H11.5A2.5 2.5 0 0 1 9 17.5V15H6.5A2.5 2.5 0 0 1 4 12.5V7.83a3 3 0 0 0 1.5.129V12.5a1 1 0 0 0 1 1H9v-2A2.5 2.5 0 0 1 11.5 9h2V6.5a1 1 0 0 0-1-1zm4.541 8a1 1 0 0 0 1-1v-2h-2a1 1 0 0 0-1 1v2z"/></svg> Mengelompokkan dan memproses file...'),updateProgress(50);let i="true"===groupBySeriesSelect.value;i&&Object.keys(seriesData.series).length>0?await processBySeries(s,r):await processAllPosts(s,r,e),updateProgress(100),updateStatus('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 2048 2048"><path fill="currentColor" d="m1491 595l90 90l-749 749l-365-365l90-90l275 275zM1024 0q141 0 272 36t245 103t207 160t160 208t103 245t37 272q0 141-36 272t-103 245t-160 207t-208 160t-245 103t-272 37q-141 0-272-36t-245-103t-207-160t-160-208t-103-244t-37-273q0-141 36-272t103-245t160-207t208-160T751 37t273-37m0 1920q123 0 237-32t214-90t182-141t140-181t91-214t32-238q0-123-32-237t-90-214t-141-182t-181-140t-214-91t-238-32q-123 0-237 32t-214 90t-182 141t-140 181t-91 214t-32 238q0 123 32 237t90 214t141 182t181 140t214 91t238 32"/></svg> Proses selesai!'),showDownloadArea(),processBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6c0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8m0 14c-3.31 0-6-2.69-6-6c0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4l-4-4z"/></svg> Ulangi',setTimeout(()=>{progress.style.display="none"},2e3)}catch(o){console.error("Error:",o),showError(`Error: ${o.message}`),updateStatus('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.015 5c0-1.414 0-2.121.512-2.56C16.038 2 16.862 2 18.508 2c1.647 0 2.47 0 2.982.44c.512.439.512 1.146.512 2.56s0 2.121-.512 2.56c-.511.44-1.335.44-2.982.44c-1.646 0-2.47 0-2.981-.44c-.512-.439-.512-1.146-.512-2.56m0 14c0-1.414 0-2.121.512-2.56c.511-.44 1.335-.44 2.981-.44c1.647 0 2.47 0 2.982.44c.512.439.512 1.146.512 2.56s0 2.121-.512 2.56c-.511.44-1.335.44-2.982.44c-1.646 0-2.47 0-2.981-.44c-.512-.439-.512-1.146-.512-2.56m-6.474-8.518l-3.018 3.013m3.018 0l-3.018-3.013m1.522 6.55c2.765 0 4.965-2.26 4.965-5.038s-2.241-5.03-5.006-5.03m.041 10.068c-2.765 0-5.047-2.26-5.047-5.038s2.241-5.03 5.006-5.03m.041 10.068c-.07 2.13 1.487 2.907 2.595 2.948h2.37M7.004 6.964c-.07-2.16 1.513-2.92 2.636-2.967h2.38" color="currentColor"/></svg> Proses gagal!')}finally{processBtn.disabled=!1}}function analyzeSeriesAndChapters(e){let t={},l=new Map,s=new Map,a=0,r=0;return e.forEach(e=>{let t=e.querySelectorAll("category"),s=Array.from(t).map(e=>e.getAttribute("term")).filter(Boolean);if(s.includes(labels_series)){let a=s.filter(e=>e!==labels_series&&!e.startsWith("http")&&"Ongoing"!==e&&"Completed"!==e&&"Hiatus"!==e);if(a.length>0){let r=a[0],n=e.querySelector("title")?.textContent||"SeriesId",i=e.querySelector("updated")?.textContent||"";l.set(r,{id:r,title:n,updated:i,entry:e})}}}),e.forEach(e=>{let t=e.querySelectorAll("category"),l=Array.from(t).map(e=>e.getAttribute("term")).filter(Boolean),n=e.querySelector("title")?.textContent||"ChapterId",i=e.querySelector("updated")?.textContent||"";if(l.includes(labels_chapter)){let o=l.filter(e=>e!==labels_chapter&&!e.startsWith("http")&&"Ongoing"!==e&&"Completed"!==e&&"Hiatus"!==e);if(o.length>0){let $=o[0];s.has($)||s.set($,[]),s.get($).push({title:n,updated:i,entry:e,uniqueId:$}),a++}}else r++}),s.forEach((e,s)=>{let a=l.get(s);if(a){let r=a.title;t[r]={name:r,uniqueId:s,chapters:e,count:e.length,lastUpdated:Math.max(...e.map(e=>new Date(e.updated).getTime())),seriesEntry:a.entry}}else{let n=`Series ${s}`;t[n]={name:n,uniqueId:s,chapters:e,count:e.length,lastUpdated:Math.max(...e.map(e=>new Date(e.updated).getTime())),seriesEntry:null}}}),console.log(`Analisis selesai: ${Object.keys(t).length} series, ${a} chapters, ${r} post lainnya`),{series:t,totalChapters:a,totalOtherPosts:r,totalSeries:Object.keys(t).length}}function displaySeriesAnalysis(){if(0===seriesData.totalSeries){seriesAnalysis.style.display="none";return}seriesAnalysis.style.display="block",seriesStats.innerHTML=`
    <div class="stat-card">
      <div class="stat-number">${seriesData.totalSeries}</div>
      <div class="stat-label">Total Series</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${seriesData.totalChapters}</div>
      <div class="stat-label">Total Chapters</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${seriesData.totalOtherPosts}</div>
      <div class="stat-label">Post Lainnya</div>
    </div>
  `,seriesTableBody.innerHTML="",Object.values(seriesData.series).forEach(e=>{let t=document.createElement("tr"),l=new Date(e.lastUpdated).toLocaleDateString("id-ID");t.innerHTML=`
      <td class="series-name">${e.name} <small>(ID: ${e.uniqueId})</small></td>
      <td><span class="chapter-count">${e.count}</span></td>
      <td>${l}</td>
    `,seriesTableBody.appendChild(t)})}async function processBySeries(e,t){let l=parseInt(postsPerFileInput.value);for(let[s,a]of Object.entries(seriesData.series)){let r=[];a.seriesEntry&&r.push(a.seriesEntry),a.chapters.forEach(e=>{r.push(e.entry)});let n=Math.ceil(r.length/l);for(let i=0;i<n;i++){let o=i*l,$=Math.min(o+l,r.length),_=r.slice(o,$),d=s.replace(/[<>:"/\\|?*]/g,"_"),p=n>1?`${selectedFile.name.replace(".xml","")}_${d}_part${i+1}.xml`:`${selectedFile.name.replace(".xml","")}_${d}.xml`,c=createXMLBlob(e,_);processedFiles.push({filename:p,blob:c,posts:_.length,size:c.size,series:s})}}if(seriesData.totalOtherPosts>0){let u=Array.from(t).filter(e=>{let t=e.querySelectorAll("category"),l=Array.from(t).map(e=>e.getAttribute("term")).filter(Boolean);return!l.includes(labels_chapter)&&!l.includes(labels_series)}),g=Math.ceil(u.length/l);for(let h=0;h<g;h++){let m=h*l,f=Math.min(m+l,u.length),y=u.slice(m,f),v=g>1?`${selectedFile.name.replace(".xml","")}_other_posts_part${h+1}.xml`:`${selectedFile.name.replace(".xml","")}_other_posts.xml`,w=createXMLBlob(e,y);processedFiles.push({filename:v,blob:w,posts:y.length,size:w.size,series:"Lainnya"})}}}async function processAllPosts(e,t,l){let s=t.length,a=Math.ceil(s/l);for(let r=0;r<a;r++){let n=r*l,i=Math.min(n+l,s),o=Array.from(t).slice(n,i),$=`${selectedFile.name.replace(".xml","")}_part${r+1}_of_${a}.xml`,_=createXMLBlob(e,o);processedFiles.push({filename:$,blob:_,posts:o.length,size:_.size})}}function createXMLBlob(e,t){let l=e.querySelector("feed"),s=l.cloneNode(!0),a=s.querySelectorAll("entry");a.forEach(e=>e.remove());let r=e.implementation.createDocument("http://www.w3.org/2005/Atom","feed",null),n=r.documentElement;Array.from(s.attributes).forEach(e=>{n.setAttribute(e.name,e.value)}),Array.from(s.childNodes).forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&"entry"!==e.tagName&&n.appendChild(r.importNode(e,!0))}),t.forEach(e=>{n.appendChild(r.importNode(e,!0))});let i=new XMLSerializer,o='<?xml version="1.0" encoding="UTF-8"?>\n'+i.serializeToString(r);return new Blob([o],{type:"application/xml;charset=utf-8"})}function showDownloadArea(){downloadArea.style.display="block",document.getElementById("downloadAllBtn").style.display="block";let e=document.createElement("table");e.className="download-table",e.innerHTML=`
    <thead>
      <tr>
        <th>Nama File</th>
        <th>Series</th>
        <th>Info</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;let t=e.querySelector("tbody");processedFiles.forEach((e,l)=>{let s=document.createElement("tr");s.innerHTML=`
      <td><strong>${e.filename}</strong></td>
      <td>${e.series||"Semua"}</td>
      <td><small>${e.posts.toLocaleString("id-ID")} post • ${formatFileSize(e.size)}</small></td>
      <td><button class="download-btn" onclick="downloadFile(${l})">Download</button></td>
    `,t.appendChild(s)}),downloadArea.appendChild(e),document.getElementById("downloadAllBtn").onclick=downloadAllFiles}function downloadFile(e){let t=processedFiles[e],l=URL.createObjectURL(t.blob),s=document.createElement("a");s.href=l,s.download=t.filename,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(l)}async function downloadAllFiles(){for(let e=0;e<processedFiles.length;e++)downloadFile(e),await new Promise(e=>setTimeout(e,500))}function readFileAsText(e){return new Promise((t,l)=>{let s=new FileReader;s.onload=e=>t(e.target.result),s.onerror=l,s.readAsText(e,"UTF-8")})}function updateProgress(e){progressBar.style.width=e+"%"}function updateStatus(e){status.innerHTML=e}function showError(e){errorMsg.innerHTML=e,errorMsg.style.display="block"}function hideError(){errorMsg.style.display="none"}function formatFileSize(e){if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function updateFileInfo(){if(!selectedFile)return;let e=document.getElementById("fileInfo");"block"===e.style.display&&(e.innerHTML=`
      <h4><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20"><path fill="currentColor" d="M4 16V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v11a1 1 0 0 1-1 1H5a1 1 0 0 0 1 1h9.5a.5.5 0 0 1 0 1H6a2 2 0 0 1-2-2M15 4a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1v11h10zM9.455 6.293a.5.5 0 0 0-.902-.017L7.19 9H6.5a.5.5 0 0 0 0 1h1a.5.5 0 0 0 .447-.276L8.98 7.66l2.066 4.546a.5.5 0 0 0 .884.05L13.283 10h.217a.5.5 0 0 0 0-1H13a.5.5 0 0 0-.429.243l-1.01 1.683z"/></svg> File Info:</h4>
      <p><strong>Nama:</strong> ${selectedFile.name}</p>
      <p><strong>Ukuran:</strong> ${formatFileSize(selectedFile.size)}</p>
      <p><strong>Tanggal:</strong> ${new Date(selectedFile.lastModified).toLocaleString("id-ID")}</p>
      <p><strong>Posts per File:</strong> ${postsPerFileInput.value}</p>
      <p><strong>Kelompokkan Series:</strong> ${"true"===groupBySeriesSelect.value?"Ya":"Tidak"}</p>
      <p><strong>Status:</strong> <span style="color: var(--warning-color);">Siap untuk dianalisis</span></p>
    `)}function measurePerformance(e,t){return async function(...l){let s=performance.now(),a=await t.apply(this,l),r=performance.now();return console.log(`${e} took ${r-s} milliseconds`),a}}uploadArea.addEventListener("click",()=>fileInput.click()),uploadArea.addEventListener("dragover",handleDragOver),uploadArea.addEventListener("drop",handleDrop),uploadArea.addEventListener("dragleave",handleDragLeave),fileInput.addEventListener("change",handleFileSelect),processBtn.addEventListener("click",()=>{labels_series=document.getElementById("labelsSeries").value,labels_chapter=document.getElementById("labelsChapter").value,console.log("Series:",labels_series),console.log("Chapter:",labels_chapter),processFile()}),postsPerFileInput.addEventListener("input",updateFileInfo),groupBySeriesSelect.addEventListener("change",updateFileInfo),document.addEventListener("keydown",function(e){if(e.ctrlKey||e.metaKey)switch(e.key){case"o":e.preventDefault(),fileInput.click();break;case"Enter":processBtn.disabled||(e.preventDefault(),processBtn.click())}}),document.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()}),document.addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation()}),window.addEventListener("error",function(e){console.error("Global error:",e.error),showError("Terjadi kesalahan tidak terduga. Silakan refresh halaman dan coba lagi.")}),window.addEventListener("unhandledrejection",function(e){console.error("Unhandled promise rejection:",e.reason),showError("Terjadi kesalahan dalam pemrosesan file. Pastikan file XML valid.")});const originalProcessFile=processFile;function initializeApp(){let e=document.createElement("div");e.style.cssText=`
          position: fixed;
          bottom: 10px;
          right: 10px;
          background: rgba(0,0,0,0.5);
          color: white;
          padding: 5px 10px;
          border-radius: 5px;
          font-size: 0.8rem;
          z-index: 1000;
        `,e.textContent="v1.3.0",document.body.appendChild(e),console.log("Mangekyō Sharingan Splitter v1.3.0 initialized")}processFile=measurePerformance("processFile",originalProcessFile),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeApp):initializeApp();